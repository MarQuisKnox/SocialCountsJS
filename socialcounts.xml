<?xml version="1.0" encoding="UTF-8"?>
<!--
    SocialCountsJS webpage
    - Written by Seon-Wook Park (http://www.swook.net/)
    - Licensed under LGPLv3
-->
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
	<meta>
		<author>Seon-Wook Park</author>
		<sampleQuery>SELECT * FROM {table} WHERE url='http://www.google.com';</sampleQuery>
	</meta>

	<bindings>
		<select itemPath="" produces="JSON">
			<inputs>
				<key id='url' type='xs:string' paramType='variable' required='true' />
			</inputs>
			<execute><![CDATA[
				var urle = encodeURIComponent(url);
				response.maxAge = 300;
				response.object = {'url':url,'counts':{
					googleplus: 0,
					facebook: 0,
					twitter: 0,
					linkedin: 0,
					reddit: 0,
					stumbleupon: 0,
					delicious: 0,
					pinterest: 0
				}};

				var st = (new Date).getTime();
				y.rest("https://apis.google.com/u/0/_/+1/fastbutton?url="+url, function (r) {
					r = y.xpath(r.response, '//div[@id="root"]//script');
					m = r.toString().match(/.*window.__SSR\s*=\s*{\s*c\s*:\s*([0-9\.]+)\s*,/);
					if (!m) return;
					response.object.counts.googleplus = m[1] ? parseInt(m[1]) : 0;
					y.log('googleplus: '+ ((new Date).getTime() - st));
				}).accept('text/html').get();

				y.rest("https://graph.facebook.com/?id="+urle, function(r) {
					r = y.xmlToJson(r.response).json;
					if (!r) return;
					var c = r.shares || r.likes;
					response.object.counts.facebook = c ? parseInt(c) : 0;
					y.log('facebook: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				y.rest("http://urls.api.twitter.com/1/urls/count.json?url="+urle, function(r) {
					var c = r.response.count;
					response.object.counts.twitter = c ? parseInt(c) : 0;
					y.log('twitter: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				y.rest("http://www.linkedin.com/countserv/count/share?format=json&url="+urle, function(r) {
					response.object.counts.linkedin = parseInt(r.response.count);
					y.log('linkedin: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				function reddit() {
				y.rest("http://www.reddit.com/api/info.json?url="+urle, function(r) {
					r = y.xmlToJson(r.response);
					if (r.error) {
						if ((new Date).getTime() - st < 1e3) reddit();
						else y.log('reddit request timed out.');
						return;
					}
				       	else if (!r.json || !r.json.data || !r.json.data.children) return;
					r = r.json.data.children;
			       		var i = 0, n = r.length;
					for (; i < n; i++) {
						if (r[i].data) response.object.counts.reddit += parseInt(r[i].data.score);
					}
					y.log('reddit: '+ ((new Date).getTime() - st));
				}).accept('application/json').header('User-Agent', 'SocialCountsJS').get();
				}; reddit();

				y.rest("http://www.stumbleupon.com/services/1.01/badge.getinfo?url="+urle, function(r) {
					r = y.xmlToJson(r.response);
					if (!r.json || !r.json.result || !r.json.result.views) return;
					r = r.json.result.views;
					response.object.counts.stumbleupon = r ? parseInt(r) : 0;
					y.log('stumbleupon: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				y.rest("http://feeds.delicious.com/v2/json/urlinfo/data?url="+urle, function(r) {
					if (!r.response) return;
					var c = r.response..total_posts;
					response.object.counts.delicious = c ? parseInt(c) : 0;
					y.log('delicious: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				y.rest("http://api.pinterest.com/v1/urls/count.json?url="+urle, function(r) {
					var m = r.response.toString().match(/"count": ([0-9]+)/);
					response.object.counts.pinterest = (m && m.length > 1) ? parseInt(m[1]) : 0;
					y.log('pinterest: '+ ((new Date).getTime() - st));
				}).accept('application/json').get();

				y.sync();
			]]></execute>
		</select>
	</bindings>
</table>
