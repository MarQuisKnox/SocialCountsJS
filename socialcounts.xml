<?xml version="1.0" encoding="UTF-8"?>
<!--
    SocialCountsJS webpage
    - Written by Seon-Wook Park (http://www.swook.net/)
    - Licensed under LGPLv3
-->
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
	<meta>
		<author>Seon-Wook Park</author>
		<sampleQuery>SELECT * FROM {table} WHERE url='http://www.google.com';</sampleQuery>
	</meta>

	<bindings>
		<select itemPath="" produces="JSON">
			<inputs>
				<key id='url' type='xs:string' paramType='variable' required='true' />
			</inputs>
			<execute><![CDATA[
				var urle = encodeURIComponent(url);
				response.object = {'url':url,'counts':{
					googleplus: 0,
					facebook: 0,
					twitter: 0,
					linkedin: 0,
					reddit: 0,
					stumbleupon: 0,
					delicious: 0,
					pinterest: 0
				}};

				y.rest("https://plusone.google.com/_/+1/fastbutton?url="+url, function (r) {
					var c = r.response.toString().match(/.*window.__SSR\s*=\s*{\s*c\s*:\s*([0-9\.]+)\s*,/)[1];
					response.object.counts.googleplus = c ? parseInt(c) : 0;
				}).accept('text/plain').get();

				y.rest("https://graph.facebook.com/?id="+urle, function(r) {
					r = y.xmlToJson(r.response).json;
					var c = r.shares || r.likes;
					response.object.counts.facebook = c ? parseFloat(c) : 0;
				}).accept('application/json').get();

				y.rest("http://urls.api.twitter.com/1/urls/count.json?url="+urle, function(r) {
					var c = r.response.count;
					response.object.counts.twitter = c ? parseFloat(c) : 0;
				}).accept('application/json').get();

				y.rest("http://www.linkedin.com/countserv/count/share?format=json&url="+urle, function(r) {
					response.object.counts.linkedin = parseInt(r.response.count);
				}).accept('application/json').get();

				y.rest("http://www.reddit.com/api/info.json?url="+urle, function(r) {
					var c = y.xmlToJson(r.response);
					if (!c.json || !c.json.data || !c.json.data.children) return;
					c = c.json.data.children;
			       		var i = 0, n = c.length;
					for (; i < n; i++) {
						response.object.counts.reddit += parseFloat(c[i].data.score);
					}
				}).accept('application/json').header('User-Agent', 'SocialCountsJS').get();

				y.rest("http://www.stumbleupon.com/services/1.01/badge.getinfo?url="+urle, function(r) {
					var c = y.xmlToJson(r.response);
					if (!c.json || !c.json.result || !c.json.result.views) return;
					c = c.json.result.views;
					response.object.counts.stumbleupon = c ? parseFloat(c) : 0;
				}).accept('application/json').get();

				y.rest("http://feeds.delicious.com/v2/json/urlinfo/data?url="+urle, function(r) {
					var c = r.response..total_posts;
					response.object.counts.delicious = c ? parseFloat(c) : 0;
				}).accept('application/json').get();

				y.rest("http://api.pinterest.com/v1/urls/count.json?url="+urle, function(r) {
					var m = r.response.toString().match(/"count": ([0-9]+)/);
					response.object.counts.pinterest = (m && m.length > 1) ? parseInt(m[1]) : 0;
				}).accept('application/json').get();

				y.sync();
			]]></execute>
		</select>
	</bindings>
</table>
